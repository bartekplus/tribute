!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Tribute=e()}(this,(function(){"use strict";class t{constructor(t){this.tribute=t,this.tribute.events=this}static keys(){return["Tab","Enter","Escape","ArrowUp","ArrowDown","Backspace"]}static digits(){return["1","2","3","4","5","6","7","8","9","0"]}static modifiers(){return["CapsLock","Control","Fn","Hyper","Meta","OS","Super","Symbol","Win"]}bind(t){t.boundKeyDown=this.keydown.bind(t,this),t.boundKeyUpInput=this.tribute.debounce(this.input.bind(t,this),this.tribute.inputDebounce||32),t.addEventListener("keydown",t.boundKeyDown,!0),t.addEventListener("keyup",t.boundKeyUpInput,!0),t.addEventListener("input",t.boundKeyUpInput,!0)}unbind(t){t.removeEventListener("keydown",t.boundKeyDown,!0),t.removeEventListener("keyup",t.boundKeyUpInput,!0),t.removeEventListener("input",t.boundKeyUpInput,!0),delete t.boundKeyDown,delete t.boundKeyUpInput}keydown(e,n){let i=!1,r=!1;const o="Tab"===n.code||"Tab"===n.key||9===n.keyCode,s=e.tribute.current.inlineSuggestion||e.tribute.range.getDocument().querySelector(".tribute-inline");if(o&&s){n.preventDefault(),n.stopImmediatePropagation(),e.tribute.current.inlineSuggestion=s,e.tribute.range.hideInlineSuggestion(),e.tribute.current.element=this,!e.tribute.current.mentionTriggerChar&&e.tribute.current.collection&&(e.tribute.current.mentionTriggerChar=e.tribute.current.collection.trigger||"");const t=e.tribute.current.inlineSuggestionItem;if(t){const i=e.tribute.current.collection.selectTemplate(t);if(null!==i)return e.tribute.replaceText(i,n,t),void e.tribute.hideMenu()}e.tribute.hideMenu()}else n instanceof KeyboardEvent&&t.modifiers().forEach((t=>{n.getModifierState(t)&&(i=!0)})),i||(t.keys().forEach((t=>{if(t===n.code&&(e.tribute.isActive||"Backspace"==n.code))return e.callbacks()[t](n,this),void(r=!0)})),e.tribute.selectByDigit&&t.digits().forEach(((t,i)=>{if(t===n.key&&e.tribute.isActive){if(i<e.tribute.current.filteredItems.length)return e.callbacks().Digit(n,i,this),void(r=!0)}}))),r||(e.tribute.lastReplacement=null,e.tribute.hideMenu())}input(t,e){const n=e instanceof CustomEvent,i=e instanceof InputEvent,r=i&&("insertText"==e.inputType||"insertCompositionText"==e.inputType||e.inputType.startsWith("deleteContent"));n||i&&!r||t.keyup.call(this,t,e)}click(t,e){const n=t.tribute;if(n.menu&&n.menu.contains(e.target)){let t=e.target;for(e.preventDefault(),e.stopImmediatePropagation();"li"!==t.nodeName.toLowerCase();){if("lh"===t.nodeName.toLowerCase())return;if(t=t.parentNode,!t||t===n.menu)throw new Error("cannot find the <li> container for the click")}n.selectItemAtIndex(t.getAttribute("data-index"),e)}else n.hideMenu()}keyup(e,n){if(n instanceof KeyboardEvent){if(n.key&&n.key.length>1)return;let e=!1;if(t.modifiers().forEach((t=>{n.getModifierState(t)&&(e=!0)})),t.keys().forEach((t=>{t!==n.code||(e=!0)})),e)return}if(!e.updateSelection(this))return;const i=e.getKeyCode(n);if(isNaN(i))return;if(e.tribute.autocompleteMode)e.tribute.current.collection=e.tribute.collection[0];else{const t=e.tribute.triggers().find((t=>t.charCodeAt(0)===i));if(e.tribute.isActive);else{if(!t)return;e.tribute.current.collection=e.tribute.collection.find((e=>e.trigger===t))}}const r=e.tribute.current.collection.menuShowMinLength;e.tribute.current.mentionText.length<r?e.tribute.hideMenu():e.tribute.showMenuFor(this,!0)}getKeyCode(t){const e=t.keyCode||t.which||t.code;return e||(t instanceof InputEvent&&t.data?t.data.charCodeAt(t.data.length-1):this.tribute.current.mentionTriggerChar?this.tribute.current.mentionTriggerChar.charCodeAt(0):this.tribute.current.mentionText?this.tribute.current.mentionText.charCodeAt(this.tribute.current.mentionText.length-1):NaN)}updateSelection(t){this.tribute.current.element=t;const e=this.tribute.range.getTriggerInfo(this.tribute.allowSpaces,this.tribute.autocompleteMode);return!!e&&(this.tribute.current.mentionTriggerChar=e.mentionTriggerChar,this.tribute.current.mentionText=e.mentionText,this.tribute.current.mentionPosition=e.mentionPosition,this.tribute.current.fullText=e.fullText,this.tribute.current.nextChar=e.nextChar,!0)}callbacks(){return{Backspace:(t,e)=>{this.tribute.lastReplacement&&(this.tribute.events.updateSelection(e)&&this.tribute.current.mentionPosition+this.tribute.current.mentionText.length==this.tribute.lastReplacement.mentionPosition+this.tribute.lastReplacement.content.length&&(t.preventDefault(),t.stopImmediatePropagation(),this.tribute.current={...this.tribute.lastReplacement},this.tribute.current.mentionText=this.tribute.lastReplacement.content,this.tribute.replaceText(this.tribute.lastReplacement.mentionText+"",t,null)),this.tribute.lastReplacement=null,this.tribute.current={}),this.tribute.hideMenu()},Digit:(t,e,n)=>{this.setActiveLi(e),this.callbacks().Enter(t,n)},Enter:(t,e)=>{this.tribute.isActive&&this.tribute.current.filteredItems&&(t.preventDefault(),t.stopImmediatePropagation(),this.tribute.selectItemAtIndex(this.tribute.menuSelected,t))},Escape:(t,e)=>{this.tribute.isActive&&(t.preventDefault(),t.stopImmediatePropagation(),this.tribute.hideMenu())},Tab:(t,e)=>{this.callbacks().Enter(t,e)},Space:(t,e)=>{this.tribute.isActive&&(this.tribute.spaceSelectsMatch?this.callbacks().Enter(t,e):this.tribute.hideMenu())},ArrowUp:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopImmediatePropagation();const e=this.tribute.current.filteredItems.length,n=this.tribute.menuSelected;e>n&&n>0?this.setActiveLi(n-1):0===n&&(this.setActiveLi(e-1),this.tribute.menu.scrollTop=this.tribute.menu.scrollHeight)}},ArrowDown:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopImmediatePropagation();const e=this.tribute.current.filteredItems.length-1,n=this.tribute.menuSelected;e>n?this.setActiveLi(n+1):e===n&&(this.setActiveLi(0),this.tribute.menu.scrollTop=0)}}}}setActiveLi(t){const e=this.tribute.menu.querySelectorAll("li"),n=e.length>>>0;this.tribute.menuSelected=t;for(let t=0;t<n;t++){const n=e[t];if(t===this.tribute.menuSelected){n.classList.add(this.tribute.current.collection.selectClass);const t=n.getBoundingClientRect(),e=this.tribute.menu.getBoundingClientRect();if(t.bottom>e.bottom){const n=t.bottom-e.bottom;this.tribute.menu.scrollTop+=n}else if(t.top<e.top){const n=e.top-t.top;this.tribute.menu.scrollTop-=n}}else n.classList.remove(this.tribute.current.collection.selectClass)}}}class e{constructor(t){this.tribute=t,this.tribute.menuEvents=this,this.menu=this.tribute.menu}bind(t){this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.tribute.debounce((()=>{this.tribute.hideMenu()}),100),this.windowResizeEvent=this.tribute.debounce((()=>{this.tribute.hideMenu()}),100),this.windowBlurEvent=()=>{this.tribute.hideMenu()},this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),window.addEventListener("blur",this.windowBlurEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}unbind(t){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),window.removeEventListener("blur",this.windowBlurEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}}class n{constructor(t){this.tribute=t,this.tribute.range=this}getDocument(){let t;return this.tribute.current.collection&&(t=this.tribute.current.collection.iframe),t?t.contentWindow.document:document}positionMenuAtCaret(t){const e=this.tribute.current;let n;this.tribute.positionMenu?(n=this.isContentEditable(e.element)?this.getContentEditableCaretPosition(e.mentionPosition+e.mentionText.length):this.getTextAreaOrInputUnderlinePosition(e.element,e.mentionPosition+e.mentionText.length),this.tribute.menu.style.top=`${n.top}px`,this.tribute.menu.style.left=`${n.left}px`,this.tribute.menu.style.right=`${n.right}px`,this.tribute.menu.style.bottom=`${n.bottom}px`,this.tribute.menu.style["max-height"]=`${n.maxHeight||500}px`,this.tribute.menu.style["max-width"]=`${n.maxWidth||300}px`,this.tribute.menu.style.position=`${n.position||"absolute"}`,this.tribute.menu.style.display="block","auto"===n.left&&(this.tribute.menu.style.left="auto"),"auto"===n.top&&(this.tribute.menu.style.top="auto"),t&&this.scrollIntoView()):this.tribute.menu.style.display="block"}showInlineSuggestion(t){const e=this.tribute.current;this.hideInlineSuggestion();const n=this.isContentEditable(e.element),i=n?this.getContentEditableInlinePosition():this.getTextAreaOrInputUnderlinePosition(e.element,e.mentionPosition+e.mentionText.length);if(!i)return;let r=this.getDocument().createElement("div");r.className="tribute-inline",r.innerText=t;const o=n&&this.getContentEditableTargetElement()||e.element,s=getComputedStyle(o);r.style.color=s.color,r.style.opacity=.5,r.style.position="fixed",r.style.left=i.left+"px";const l="number"==typeof i.height?i.top-i.height:i.top;r.style.top=l+"px",r.style.pointerEvents="none",r.style.whiteSpace="pre-wrap",r.style.zIndex=1e4,r.style.font=s.font,r.style.fontFamily=s.fontFamily,r.style.fontSize=s.fontSize,r.style.fontWeight=s.fontWeight,r.style.fontStyle=s.fontStyle,r.style.fontVariant=s.fontVariant,r.style.letterSpacing=s.letterSpacing,r.style.wordSpacing=s.wordSpacing,r.style.textTransform=s.textTransform,r.style.lineHeight=s.lineHeight,r.style.direction=s.direction,r.style.fontFeatureSettings=s.fontFeatureSettings,r.style.fontKerning=s.fontKerning,r.style.textAlign=s.textAlign,r.style.WebkitFontSmoothing=s.WebkitFontSmoothing,r.style.MozOsxFontSmoothing=s.MozOsxFontSmoothing,i.maxWidth&&(r.style.maxWidth=i.maxWidth+"px"),this.getDocument().body.appendChild(r),this.tribute.current.inlineSuggestion=r}getContentEditableInlinePosition(){const t=this.getWindowSelection();if(!t||0===t.rangeCount)return null;const e=t.getRangeAt(0).cloneRange();let n=e.getBoundingClientRect();if(!n||0===n.height){const i=this.getDocument().createTextNode("​");e.insertNode(i),n=i.getBoundingClientRect(),i.parentNode&&i.parentNode.removeChild(i),t.removeAllRanges(),t.addRange(e)}if(!n)return null;const i=this.getContentEditableTargetElement()||this.tribute.current.element,r=getComputedStyle(i),o=parseFloat(r.fontSize)||0;let s=parseFloat(r.lineHeight);s&&!Number.isNaN(s)||(s=o?1.2*o:0);const l=Math.max(n.height||0,s||0),c=n.top-Math.max(0,l-(n.height||0))/2,u=this.tribute.current.element.getBoundingClientRect(),a=Math.max(0,u.right-n.left);return{position:"fixed",left:n.left,top:c+l,height:l,maxWidth:a}}getContentEditableTargetElement(){const t=this.getWindowSelection();if(!t||0===t.rangeCount)return null;let e=t.getRangeAt(0).startContainer;return 3===e.nodeType&&(e=e.parentNode),e}hideInlineSuggestion(){const t=this.tribute.current.inlineSuggestion;t&&t.parentNode&&t.parentNode.removeChild(t),this.tribute.current.inlineSuggestion=null;this.getDocument().querySelectorAll(".tribute-inline").forEach((t=>{t.parentNode&&t.parentNode.removeChild(t)}))}replaceTriggerText(t,e,n){const i=this.tribute.current;this.hideInlineSuggestion();const r={item:n,context:i,event:e,text:t},o=new CustomEvent("tribute-replaced",{detail:r});if(this.isContentEditable(i.element)){const{sel:e,range:n}=this.getContentEditableSelectionStart(!0),r=new StaticRange({startContainer:e.anchorNode,startOffset:e.anchorOffset-i.mentionText.length,endContainer:e.anchorNode,endOffset:e.anchorOffset});t+="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ",i.element.dispatchEvent(new InputEvent("beforeinput",{bubbles:!0,data:t,cancelable:!0,inputType:"insertReplacementText",targetRanges:[r]})),this.pasteContentEditable(t,i.mentionText.length+i.mentionTriggerChar.length)}else{const e=this.tribute.current.element,n="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";t=this.stripHtml(t),t+=n;const r=i.mentionPosition;let o=i.mentionPosition+i.mentionText.length+n.length;!this.tribute.autocompleteMode&&i.mentionTriggerChar.length&&(o+=i.mentionTriggerChar.length-1),e.value=e.value.substring(0,r)+t+e.value.substring(o,e.value.length),e.selectionStart=r+t.length,e.selectionEnd=r+t.length}i.element.dispatchEvent(new CustomEvent("input",{bubbles:!0,detail:r})),i.element.dispatchEvent(o)}pasteContentEditable(t,e){const{sel:n,range:i}=this.getContentEditableSelectionStart(!0);if(n&&n.anchorNode){const r=this.stripHtml(t),o=t!==r,s=n.anchorNode.nodeValue||"";!o&&n.anchorOffset>=e&&n.anchorOffset<=s.length?this.pasteText(n,i,r,e):this.pasteHtml(n,i,t,e)}}pasteText(t,e,n,i){const r=t.anchorNode.nodeValue.substring(0,t.anchorOffset-i),o=t.anchorNode.nodeValue.substring(t.anchorOffset,t.anchorNode.nodeValue.length);t.anchorNode.nodeValue=r+n+o,e.setStart(t.anchorNode,r.length+n.length),e.collapse(!0),t.removeAllRanges(),t.addRange(e),t.collapseToEnd()}pasteHtml(t,e,n,i){const r=t.getRangeAt(0);let o;if(3===r.startContainer.nodeType&&r.startOffset>=i)r.setStart(r.startContainer,r.startOffset-i),r.deleteContents(),o=r;else{for(let e=0;e<i;e++)t.modify("extend","backward","character");o=t.getRangeAt(0),o.deleteContents()}const s=this.getDocument().createElement("div");s.innerHTML=n;const l=this.getDocument().createDocumentFragment();let c,u;for(;c=s.firstChild;)u=l.appendChild(c);o.insertNode(l),u&&(o.setStart(u,u.length),o.setEnd(u,u.length),o.collapse(!0),t.removeAllRanges(),t.addRange(o),t.collapseToEnd())}stripHtml(t){const e=this.getDocument().createElement("DIV");return e.innerHTML=t,e.textContent||e.innerText||""}getWindowSelection(){if(this.tribute.collection.iframe)return this.tribute.collection.iframe.contentWindow.getSelection();const t=this.tribute.current.element.getRootNode();return t.getSelection?t.getSelection():window.getSelection()}getContentEditableSelectionStart(t){const e=this.getWindowSelection();if(!e.isCollapsed)return{sel:null,range:null,direction:null};const n=e.anchorOffset<=e.focusOffset,i=e.getRangeAt(0);let r=e.anchorNode;if(r&&3!==r.nodeType){const t=r.childNodes;if(t&&t.length){const n=t[Math.max(0,Math.min(i.startOffset-1,t.length-1))];n&&3===n.nodeType&&(i.setStart(n,n.textContent.length),i.collapse(!0),e.removeAllRanges(),e.addRange(i),r=n)}}const o=r.textContent||"",s=i.startOffset;let l=o.length>s?o[s]:null;if(null===l&&r.nextSibling&&r.nextSibling.textContent){const t=r.nextSibling.textContent;l=t.length?t[0]:null}const c=!this.tribute.autocompleteSeparator||l&&l.match(this.tribute.autocompleteSeparator);return e.collapseToEnd(),l&&!c&&t&&e.modify("move","forward","word"),{sel:e,range:i,direction:n}}getWholeWordsUpToCharIndex(t,e){if(this.tribute.autocompleteSeparator){let n=0;const i=t.split(this.tribute.autocompleteSeparator).filter((function(t){return t.trim()}));for(let r=0,o=i.length;r<o;r++){const o=t.indexOf(i[r],n);if(n+=i[r].length,e>=o&&e<=o+i[r].length){e=o+i[r].length;break}}}const n=t.length>e?t[e]:"";return[t.substring(0,e),n]}getTextForCurrentSelection(){const t=this.tribute.current;let e=null,n="";if(this.isContentEditable(t.element)){const{sel:t,range:i,direction:r}=this.getContentEditableSelectionStart(!0);if(t){const o=t.anchorNode.textContent,s=t.getRangeAt(0).startOffset;e=t.toString().trim(),n=o.length>s?o[s]:"";for(let n=0;n<this.tribute.numberOfWordsInContextText;n++){t.modify("extend","backward","word");const n=t.toString();n.length>e.length&&n.endsWith(e)&&(e=n)}this.restoreSelection(t,i,r)}}else{const t=this.tribute.current.element;if(t){const i=t.selectionStart,r=t.selectionEnd;if(t.value&&i>=0&&i===r){const r=this.getWholeWordsUpToCharIndex(t.value,i);e=r[0],n=r[1]}}}return{effectiveRange:e,nextChar:n}}getLastWordInText(t){if(this.tribute.autocompleteSeparator){const e=t.split(this.tribute.autocompleteSeparator);return e.length?e[e.length-1]:" "}if(this.tribute.autocompleteMode){const e=t.split(/\s+/);return e.length?e[e.length-1]:""}return t}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}getTriggerInfo(t,e){let n=!0;const{effectiveRange:i,nextChar:r}=this.getTextForCurrentSelection();if(null===i)return null;const o=this.getLastWordInText(i);if(e)return{mentionPosition:i.length-o.length,mentionText:o,fullText:i,nextChar:r,mentionTriggerChar:""};if(null!=i){let e,r=-1;if(this.tribute.collection.forEach((t=>{const o=t.trigger,s="("+(t.requireLeadingSpace?"\\s":"")+this.escapeRegExp(o)+")(?!.*\\1)",l=i.match(RegExp(s)),c=l?l.index+(t.requireLeadingSpace?1:0):i.startsWith(o)?0:-1;c>r&&(r=c,e=o,n=t.requireLeadingSpace)})),r>=0&&(0===r||!n||/\s/.test(i.substring(r-1,r)))){const n=i.substring(r+e.length,i.length);e=i.substring(r,r+e.length);const o=n.substring(0,1),s=n.length>0&&(" "===o||" "===o),l=n!==n.trimEnd();if(!s&&(t||!l))return{mentionPosition:r,mentionText:n,mentionTriggerChar:e,fullText:i,nextChar:""}}}}isContentEditable(t){return"INPUT"!==t.nodeName&&"TEXTAREA"!==t.nodeName}isMenuOffScreen(t,e){const n=window.innerWidth,i=window.innerHeight,r=this.getDocument().documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),s=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l="number"==typeof t.top?t.top:t.bottom-e.height,c="number"==typeof t.right?t.right:t.left+e.width,u="number"==typeof t.bottom?t.bottom:t.top+e.height,a="number"==typeof t.left?t.left:t.right-e.width;return{top:l<Math.floor(s),right:c>Math.ceil(o+n),bottom:u>Math.ceil(s+i),left:a<Math.floor(o)}}getMenuDimensions(){const t={width:null,height:null};return this.tribute.menu.style.top="0px",this.tribute.menu.style.left="0px",this.tribute.menu.style.right=null,this.tribute.menu.style.bottom=null,this.tribute.menu.style.position="fixed",this.tribute.menu.style.visibility="hidden",this.tribute.menu.style.display="block",t.width=this.tribute.menu.offsetWidth,t.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.display="none",this.tribute.menu.style.visibility="visible",t}getTextAreaOrInputUnderlinePosition(t,e,n){const i=this.getDocument().createElement("div");i.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(i);const r=i.style,o=window.getComputedStyle?getComputedStyle(t):t.currentStyle;r.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(r.wordWrap="break-word"),r.position="absolute",r.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach((t=>{r[t]=o[t]}));const s=this.getDocument().createElement("span");s.textContent=t.value.substring(0,e),i.appendChild(s),"INPUT"===t.nodeName&&(i.textContent=i.textContent.replace(/\s/g," "));const l=this.getDocument().createElement("span");i.appendChild(l);const c=this.getDocument().createElement("span");c.textContent=t.value.substring(e,e+1),i.appendChild(c);const u=t.getBoundingClientRect();i.style.position="fixed",i.style.left=u.left+"px",i.style.top=u.top+"px",i.style.width=u.width+"px",i.style.height=u.height+"px",i.scrollTop=t.scrollTop;const a=l.getBoundingClientRect(),h=c.getBoundingClientRect(),d=i.getBoundingClientRect(),g=parseFloat(o.fontSize)||0;let m=parseFloat(o.lineHeight);m&&!Number.isNaN(m)||(m=g?1.2*g:0);const p=m||g||d.height,f=c.textContent&&h.height?h:a,b=f.height||p,T=Math.max(b,p),x=Math.max(0,T-b),v=f.top-x/2;this.getDocument().body.removeChild(i);const C=function(t,e,n){return Math.max(e,Math.min(t,n))},S={height:Math.min(d.height,T),left:C(a.left,d.left,d.left+d.width),top:C(v,d.top,d.top+d.height)};return this.getFixedCoordinatesRelativeToRect(S)}getContentEditableCaretPosition(t){const{sel:e,range:n,direction:i}=this.getContentEditableSelectionStart(!1),r=e.getRangeAt(0);this.restoreSelection(e,n,i);let o=r.getBoundingClientRect();if(e.anchorNode.parentNode){const t=e.anchorNode.parentNode.getBoundingClientRect(),n=function(t,e,n){return Math.max(e,Math.min(t,n))};o={height:Math.min(t.height,o.height),left:n(o.left,t.left,t.left+t.width),top:n(o.top,t.top,t.top+t.height)}}return this.getFixedCoordinatesRelativeToRect(o)}getFixedCoordinatesRelativeToRect(t){const e={position:"fixed",left:t.left,top:t.top+t.height,height:t.height,width:t.width},n=this.getMenuDimensions(),i=t.top,r=window.innerHeight-(t.top+t.height);r<n.height&&(i>=n.height||i>r?(e.top="auto",e.bottom=window.innerHeight-t.top,r<n.height&&(e.maxHeight=i)):i<n.height&&(e.maxHeight=r));const o=t.left,s=window.innerWidth-t.left;return s<n.width&&(o>=n.width||o>s?(e.left="auto",e.right=window.innerWidth-t.left,s<n.width&&(e.maxWidth=o)):o<n.width&&(e.maxWidth=s)),e}scrollIntoView(t){let e,n=this.menu;if(void 0===n)return;for(;void 0===e||0===e.height;)if(e=n.getBoundingClientRect(),0===e.height&&(n=n.childNodes[0],void 0===n||!n.getBoundingClientRect))return;const i=e.top,r=i+e.height;if(i<0)window.scrollTo(0,window.pageYOffset+e.top-20);else if(r>window.innerHeight){let t=window.pageYOffset+e.top-20;t-window.pageYOffset>100&&(t=window.pageYOffset+100);let n=window.pageYOffset-(window.innerHeight-r);n>t&&(n=t),window.scrollTo(0,n)}}restoreSelection(t,e,n=!0){if(t.removeAllRanges(),n)t.addRange(e);else{const n=e.cloneRange();n.collapse(!1),t.addRange(n),t.extend(e.startContainer,e.startOffset)}}}class i{constructor(t){this.tribute=t,this.tribute.search=this}match(t,e,n){const i=(n=n||{}).pre||"",r=n.post||"",o=n.caseSensitive&&e||e.toLowerCase();if(n.skip)return{rendered:e,score:0};t=n.caseSensitive&&t||t.toLowerCase();const s=this.traverse(o,t,0,0,[]);return s?{rendered:this.render(e,s.cache,i,r),score:s.score}:null}traverse(t,e,n,i,r){if(this.tribute.autocompleteMode&&this.tribute.autocompleteSeparator&&(e=e.split(this.tribute.autocompleteSeparator).splice(-1)[0]),e.length===i)return{score:this.calculateScore(r),cache:r.slice()};if(t.length===n||e.length-i>t.length-n)return;const o=e[i];let s,l,c=t.indexOf(o,n);for(;c>-1;){if(r.push(c),l=this.traverse(t,e,c+1,i+1,r),r.pop(),!l)return s;(!s||s.score<l.score)&&(s=l),c=t.indexOf(o,c+1)}return s}calculateScore(t){let e=0,n=1;return t.forEach(((i,r)=>{r>0&&(t[r-1]+1===i?n+=n+1:n=1),e+=n})),e}render(t,e,n,i){let r=t.substring(0,e[0]);return e.forEach(((o,s)=>{r+=n+t[o]+i+t.substring(o+1,e[s+1]?e[s+1]:t.length)})),r}filter(t,e,n){return n=n||{},e.reduce(((e,i,r,o)=>{let s=i;n.extract&&(s=n.extract(i),s||(s=""));const l=this.match(t,s,n);return null!==l&&(e[e.length]={string:l.rendered,score:l.score,index:r,original:i}),e}),[]).sort(((t,e)=>{const n=e.score-t.score;return n||t.index-e.index}))}}class r{constructor({values:o=null,loadingItemTemplate:s=null,iframe:l=null,selectClass:c="highlight",containerClass:u="tribute-container",itemClass:a="",trigger:h="@",autocompleteMode:d=!1,autocompleteSeparator:g=RegExp(/\s+/),selectTemplate:m=null,menuItemTemplate:p=null,lookup:f="key",fillAttr:b="value",collection:T=null,menuContainer:x=null,noMatchTemplate:v=null,requireLeadingSpace:C=!0,allowSpaces:S=!1,replaceTextSuffix:y=null,positionMenu:w=!0,spaceSelectsMatch:E=!1,searchOpts:M={},menuItemLimit:I,menuShowMinLength:A=0,keys:R=null,numberOfWordsInContextText:L=5,supportRevert:N=!1,selectByDigit:k=!1,inline:D=!1}){if(this.autocompleteMode=d,this.autocompleteSeparator=g,this.menuSelected=0,this.current={},this.lastReplacement=null,this.isActive=!1,this.activationPending=!1,this.menuContainer=x,this.allowSpaces=S,this.replaceTextSuffix=y,this.positionMenu=w,this.spaceSelectsMatch=E,this.numberOfWordsInContextText=L,this.supportRevert=N,this.selectByDigit=k,this.inline=D,R&&(t.keys=R),this.autocompleteMode&&(h="",S=!1),o)this.collection=[{trigger:h,iframe:l,selectClass:c,containerClass:u,itemClass:a,selectTemplate:(m||r.defaultSelectTemplate).bind(this),menuItemTemplate:(p||r.defaultMenuItemTemplate).bind(this),noMatchTemplate:(t=>"string"==typeof t?""===t.trim()?null:t:"function"==typeof t?t.bind(this):v||function(){return"<li>No Match Found!</li>"})(v),lookup:f,fillAttr:b,values:o,loadingItemTemplate:s,requireLeadingSpace:C,searchOpts:M,menuItemLimit:I,menuShowMinLength:A,inline:D}];else{if(!T)throw new Error("[Tribute] No collection specified.");this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=T.map((t=>({trigger:t.trigger||h,iframe:t.iframe||l,selectClass:t.selectClass||c,containerClass:t.containerClass||u,itemClass:t.itemClass||a,selectTemplate:(t.selectTemplate||r.defaultSelectTemplate).bind(this),menuItemTemplate:(t.menuItemTemplate||r.defaultMenuItemTemplate).bind(this),noMatchTemplate:(t=>"string"==typeof t?""===t.trim()?null:t:"function"==typeof t?t.bind(this):v||function(){return"<li>No Match Found!</li>"})(v),lookup:t.lookup||f,fillAttr:t.fillAttr||b,values:t.values,loadingItemTemplate:t.loadingItemTemplate,requireLeadingSpace:t.requireLeadingSpace,searchOpts:t.searchOpts||M,menuItemLimit:t.menuItemLimit||I,menuShowMinLength:t.menuShowMinLength||A,inline:void 0!==t.inline?t.inline:D})))}new n(this),new t(this),new e(this),new i(this)}get isActive(){return this._isActive}set isActive(t){if(this._isActive!==t&&(this._isActive=t,this.current&&this.current.element)){const e=new CustomEvent(`tribute-active-${t}`);this.current.element.dispatchEvent(e)}}static defaultSelectTemplate(t){return void 0===t?`${this.current.collection.trigger}${this.current.mentionText}`:this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+t.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+t.original[this.current.collection.fillAttr]}static defaultMenuItemTemplate(t){return t.string}static inputTypes(){return["TEXTAREA","INPUT"]}triggers(){return this.collection.map((t=>t.trigger))}attach(t){if(!t)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&t instanceof jQuery&&(t=t.get()),t.constructor===NodeList||t.constructor===HTMLCollection||t.constructor===Array){const e=t.length;for(let n=0;n<e;++n)this._attach(t[n])}else this._attach(t)}_attach(t){t.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+t.nodeName),this.ensureEditable(t),this.events.bind(t),t.setAttribute("data-tribute",!0)}ensureEditable(t){if(-1===r.inputTypes().indexOf(t.nodeName)){if(!t.contentEditable)throw new Error("[Tribute] Cannot bind to "+t.nodeName);t.contentEditable=!0}}createMenu(t,e){const n=window.getComputedStyle?getComputedStyle(e):e.currentStyle,i=this.range.getDocument().createElement("div"),r=this.range.getDocument().createElement("ul");return i.className=t,i.setAttribute("tabindex","0"),i.appendChild(r),i.style.fontSize=Math.round(.9*parseInt(n.fontSize))+"px",i.style.display="none",["fontStyle","fontVariant","fontWeight","fontStretch","fontSizeAdjust","fontFamily"].forEach((t=>{i.style[t]=n[t]})),this.menuContainer?this.menuContainer.appendChild(i):this.range.getDocument().body.appendChild(i)}showMenuFor(t,e){if(this.isActive&&this.current.element===t&&this.current.mentionText===this.currentMentionTextSnapshot)return;this.current.element=t,this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass,t),t.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.activationPending=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText="");const n=(t,n,i=null)=>{if(!this.activationPending)return;if(this.activationPending=!1,this.range.getDocument().activeElement!==this.current.element)return;if(n)return this.current.mentionPosition-=n.length,this.current.mentionText=this.current.fullText.slice(-n.length),void this.replaceText(n.text,null,null);let r=this.search.filter(this.current.mentionText,t,{pre:this.current.collection.searchOpts.pre||"<span>",post:this.current.collection.searchOpts.post||"</span>",skip:this.current.collection.searchOpts.skip||!1,caseSensitive:this.current.collection.searchOpts.caseSensitive||!1,extract:t=>{if("string"==typeof this.current.collection.lookup)return t[this.current.collection.lookup];if("function"==typeof this.current.collection.lookup)return this.current.collection.lookup(t,this.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});r=r.slice(0,this.current.collection.menuItemLimit),this.current.filteredItems=r;const o=!0===this.current.collection.inline;let s=!1;const l=this.menu.querySelector("ul");let c=!1;if(r.length){if(o){this.range.hideInlineSuggestion(),this.current.element&&this.events.updateSelection(this.current.element);let t=this.current.mentionText||"";const e=this.current.mentionTriggerChar||this.current.collection&&this.current.collection.trigger||"";if(this.current.element){let n=null;if(this.range.isContentEditable(this.current.element)){const t=this.range.getContentEditableSelectionStart(!1);if(t&&t.range){const e=t.range.cloneRange();e.selectNodeContents(this.current.element),e.setEnd(t.range.startContainer,t.range.startOffset),n=e.toString()}else n=this.current.element.textContent||this.current.fullText||""}else{const t=this.current.element.value||"",e=this.current.element.selectionStart;n="number"==typeof e?t.substring(0,e):t}let i=e,r=i&&n?n.lastIndexOf(i):-1;if(r<0){let t=-1,e="";this.collection.forEach((i=>{if(!i.trigger)return;const r=n&&i.trigger?n.lastIndexOf(i.trigger):-1;r>t&&(t=r,e=i.trigger)})),t>=0&&(i=e,r=t)}if(r>=0&&i){const e=n.substring(r+i.length);!e.length&&t||(t=e,this.current.mentionPosition=r,this.current.mentionTriggerChar=i)}}t!==this.current.mentionText&&(this.current.mentionText=t);const n=r[0];if(n){let e=n.original[this.current.collection.fillAttr||"value"];if(e||(e=this.current.collection.menuItemTemplate(n)),e.toLowerCase().startsWith(t.toLowerCase())){const i=e.substring(t.length);i?(this.range.showInlineSuggestion(i),s=!0,this.current.inlineSuggestionText=e,this.current.inlineSuggestionItem=n):this.range.hideInlineSuggestion()}else this.range.hideInlineSuggestion()}else this.range.hideInlineSuggestion();return s||(this.current.inlineSuggestionItem=null,this.current.inlineSuggestionText=null),this.menu&&(this.menu.style.display="none"),void(this.isActive=s)}this.range.hideInlineSuggestion(),this.current.inlineSuggestionItem=null,this.current.inlineSuggestionText=null;const t=this.range.getDocument().createDocumentFragment();if(l.innerHTML="",i){const t=this.range.getDocument().createElement("lh");t.innerHTML=i,l.appendChild(t)}r.forEach(((e,n)=>{const i=this.range.getDocument().createElement("li");i.setAttribute("data-index",n),i.className=this.current.collection.itemClass,i.addEventListener("mouseover",function(t){this.events.setActiveLi(t)}.bind(this,n)),this.menuSelected===n&&i.classList.add(this.current.collection.selectClass),i.innerHTML=this.current.collection.menuItemTemplate(e),this.selectByDigit&&(i.innerHTML=((n+1)%10).toString()+". "+i.innerHTML),t.appendChild(i)})),l.appendChild(t),c=!0}else{this.range.hideInlineSuggestion(),this.current.inlineSuggestionItem=null,this.current.inlineSuggestionText=null;const t=new CustomEvent("tribute-no-match",{detail:this.menu});this.current.element.dispatchEvent(t),o||"function"==typeof this.current.collection.noMatchTemplate&&!this.current.collection.noMatchTemplate()||!this.current.collection.noMatchTemplate?c=!1:("function"==typeof this.current.collection.noMatchTemplate?l.innerHTML=this.current.collection.noMatchTemplate():l.innerHTML=this.current.collection.noMatchTemplate,c=!0)}c?(this.isActive=!0,this.range.positionMenuAtCaret(e)):this.isActive&&(this.isActive=!1,this.hideMenu())};"function"==typeof this.current.collection.values?(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(e)),this.current.collection.values(this.current.mentionText,n,this.current.fullText,this.current.nextChar)):n(this.current.collection.values)}showMenuForCollection(t,e){this.events.updateSelection(t)&&(t!==this.range.getDocument().activeElement&&(this.placeCaretAtEnd(t),t.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(t,this.current.collection.trigger)),this.current.collection=this.collection[e||0],this.showMenuFor(t))}placeCaretAtEnd(t){if(t.focus(),void 0!==window.getSelection&&void 0!==this.range.getDocument().createRange){const e=this.range.getDocument().createRange();e.selectNodeContents(t),e.collapse(!1);const n=window.getSelection();n.removeAllRanges(),n.addRange(e)}else if(void 0!==this.range.getDocument().body.createTextRange){const e=this.range.getDocument().body.createTextRange();e.moveToElementText(t),e.collapse(!1),e.select()}}insertTextAtCursor(t){const e=window.getSelection(),n=e.getRangeAt(0);n.deleteContents();const i=this.range.getDocument().createTextNode(t);n.insertNode(i),n.selectNodeContents(i),n.collapse(!1),e.removeAllRanges(),e.addRange(n)}insertAtCaret(t,e){const n=t.scrollTop;let i=t.selectionStart;const r=t.value.substring(0,i),o=t.value.substring(t.selectionEnd,t.value.length);t.value=r+e+o,i+=e.length,t.selectionStart=i,t.selectionEnd=i,t.focus(),t.scrollTop=n}hideMenu(){this.menu&&(this.menu.remove(),this.menu=null),this.range.hideInlineSuggestion(),this.isActive=!1,this.activationPending=!1,this.current={}}selectItemAtIndex(t,e){if("number"==typeof(t=parseInt(t))&&!isNaN(t)&&e.target){const n=this.current.filteredItems[t],i=this.current.collection.selectTemplate(n);null!==i&&this.replaceText(i,e,n)}this.hideMenu()}replaceText(t,e,n){this.supportRevert&&(this.lastReplacement={...this.current},this.lastReplacement.content=t),this.range.replaceTriggerText(t,e,n)}_append(t,e,n){if("function"==typeof t.values)throw new Error("Unable to append to values, as it is a function.");t.values=n?e:t.values.concat(e)}append(t,e,n){const i=parseInt(t);if("number"!=typeof i)throw new Error("please provide an index for the collection to update.");const r=this.collection[i];this._append(r,e,n)}appendCurrent(t,e){if(!this.isActive)throw new Error("No active state. Please use append instead and pass an index.");this._append(this.current.collection,t,e)}detach(t){if(!t)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&t instanceof jQuery&&(t=t.get()),t.constructor===NodeList||t.constructor===HTMLCollection||t.constructor===Array){const e=t.length;for(let n=0;n<e;++n)this._detach(t[n])}else this._detach(t)}_detach(t){this.events.unbind(t),t.tributeMenu&&this.menuEvents.unbind(t.tributeMenu),setTimeout((()=>{t.removeAttribute("data-tribute"),this.isActive=!1,t.tributeMenu&&t.tributeMenu.remove()}))}debounce(t,e,n={leading:!0,trailing:!0}){let i=null;return(...r)=>{const o=n.leading&&null===i,s=(e=>{i=null,e&&t.apply(this,r)}).bind(this,!o&&n.trailing);clearTimeout(i),i=setTimeout(s,e),o&&t.apply(this,r)}}}return r}));
//# sourceMappingURL=tribute.min.js.map
