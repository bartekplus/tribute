!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Tribute=e()}(this,(function(){"use strict";function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null===this)throw TypeError('"this" is null or not defined');const e=Object(this),n=e.length>>>0;if("function"!=typeof t)throw TypeError("predicate must be a function");const i=arguments[1];let o=0;for(;o<n;){const n=e[o];if(t.call(i,n,o,e))return n;o++}},configurable:!0,writable:!0}),"undefined"!=typeof window&&"function"!=typeof window.CustomEvent&&(void 0!==window.Event&&(t.prototype=window.Event.prototype),window.CustomEvent=t);class e{constructor(t){this.tribute=t,this.tribute.events=this}static keys(){return["Tab","Enter","Escape","ArrowUp","ArrowDown"]}static modifiers(){return["CapsLock","Control","Fn","Hyper","Meta","OS","Super","Symbol","Win"]}bind(t){t.boundKeyDown=this.keydown.bind(t,this),t.boundKeyUp=this.keyup.bind(t,this),t.boundInput=this.input.bind(t,this),t.addEventListener("keydown",t.boundKeyDown,!0),t.addEventListener("keyup",t.boundKeyUp,!0),t.addEventListener("input",t.boundInput,!0)}unbind(t){t.removeEventListener("keydown",t.boundKeyDown,!0),t.removeEventListener("keyup",t.boundKeyUp,!0),t.removeEventListener("input",t.boundInput,!0),delete t.boundKeyDown,delete t.boundKeyUp,delete t.boundInput}keydown(t,n){if(t.shouldDeactivate(n)&&t.tribute.hideMenu(),n instanceof KeyboardEvent){let t=!1;if(e.modifiers().forEach((e=>{n.getModifierState(e)&&(t=!0)})),t)return}t.tribute.isActive&&e.keys().forEach((e=>{e===n.code&&t.callbacks()[e](n,this)}))}input(t,e){e instanceof CustomEvent||t.keyup.call(this,t,e)}click(t,e){const n=t.tribute;if(n.menu&&n.menu.contains(e.target)){let t=e.target;for(e.preventDefault(),e.stopPropagation();"li"!==t.nodeName.toLowerCase();)if(t=t.parentNode,!t||t===n.menu)throw new Error("cannot find the <li> container for the click");n.selectItemAtIndex(t.getAttribute("data-index"),e)}else n.hideMenu()}keyup(t,n){if(!t.updateSelection(this))return;const i=t.getKeyCode(t,this,n);if(n instanceof KeyboardEvent){let t=!1;if(e.modifiers().forEach((e=>{n.getModifierState(e)&&(t=!0)})),e.keys().forEach((e=>{e!==n.code||(t=!0)})),t)return}if(!t.tribute.allowSpaces&&t.tribute.hasTrailingSpace)return t.tribute.hasTrailingSpace=!1,void t.callbacks().Space(n,this);i&&!isNaN(i)?t.tribute.autocompleteMode&&String.fromCharCode(i).match(/(\w|\s)/g)?t.tribute.current.trigger="":t.tribute.current.trigger=t.tribute.triggers().find((t=>t.charCodeAt(0)===i)):t.tribute.autocompleteMode&&n instanceof InputEvent&&(t.tribute.current.trigger=""),(t.tribute.current.trigger||""===t.tribute.current.trigger&&t.tribute.autocompleteMode)&&(t.tribute.current.collection=t.tribute.collection.find((e=>e.trigger===t.tribute.current.trigger)),!t.tribute.current.collection||t.tribute.current.collection.menuShowMinLength>t.tribute.current.mentionText.length||t.tribute.showMenuFor(this,!0))}shouldDeactivate(t){let n=!1;return e.keys().forEach((e=>{e!==t.code||(n=!0)})),!n&&!!this.tribute.isActive}getKeyCode(t,e,n){const i=t.tribute,o=i.range.getTriggerInfo(!1,i.hasTrailingSpace,!0,i.allowSpaces,i.autocompleteMode);return n.keyCode||n.which||n.code?n.keyCode||n.which||n.code:o?o.mentionTriggerChar?o.mentionTriggerChar.charCodeAt(0):o.mentionText.charCodeAt(o.mentionText.length-1):NaN}updateSelection(t){let e=!1;this.tribute.current.element=t;const n=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);return n?(this.tribute.current.selectedPath=n.mentionSelectedPath,this.tribute.current.mentionText=n.mentionText,this.tribute.current.fullText=n.fullText,this.tribute.current.selectedOffset=n.mentionSelectedOffset,this.tribute.current.info=n,e=!0):this.tribute.current={},e}callbacks(){return{Enter:(t,e)=>{this.tribute.isActive&&this.tribute.current.filteredItems&&(t.preventDefault(),t.stopPropagation(),this.tribute.selectItemAtIndex(this.tribute.menuSelected,t))},Escape:(t,e)=>{this.tribute.isActive&&(t.preventDefault(),t.stopPropagation(),this.tribute.hideMenu())},Tab:(t,e)=>{this.callbacks().Enter(t,e)},Space:(t,e)=>{this.tribute.isActive&&(this.tribute.spaceSelectsMatch?this.callbacks().Enter(t,e):this.tribute.allowSpaces||(t.stopPropagation(),setTimeout((()=>{this.tribute.hideMenu()}),0)))},ArrowUp:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopPropagation();const e=this.tribute.current.filteredItems.length,n=this.tribute.menuSelected;e>n&&n>0?(this.tribute.menuSelected--,this.setActiveLi()):0===n&&(this.tribute.menuSelected=e-1,this.setActiveLi(),this.tribute.menu.scrollTop=this.tribute.menu.scrollHeight)}},ArrowDown:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopPropagation();const e=this.tribute.current.filteredItems.length-1,n=this.tribute.menuSelected;e>n?(this.tribute.menuSelected++,this.setActiveLi()):e===n&&(this.tribute.menuSelected=0,this.setActiveLi(),this.tribute.menu.scrollTop=0)}},Delete:(t,e)=>{this.tribute.isActive&&this.tribute.current.mentionText.length<1?this.tribute.hideMenu():this.tribute.isActive&&this.tribute.showMenuFor(e)}}}setActiveLi(t){const e=this.tribute.menu.querySelectorAll("li"),n=e.length>>>0;t&&(this.tribute.menuSelected=parseInt(t));for(let t=0;t<n;t++){const n=e[t];if(t===this.tribute.menuSelected){n.classList.add(this.tribute.current.collection.selectClass);const t=n.getBoundingClientRect(),e=this.tribute.menu.getBoundingClientRect();if(t.bottom>e.bottom){const n=t.bottom-e.bottom;this.tribute.menu.scrollTop+=n}else if(t.top<e.top){const n=e.top-t.top;this.tribute.menu.scrollTop-=n}}else n.classList.remove(this.tribute.current.collection.selectClass)}}getFullHeight(t,e){const n=t.getBoundingClientRect().height;if(e){const e=t.currentStyle||window.getComputedStyle(t);return n+parseFloat(e.marginTop)+parseFloat(e.marginBottom)}return n}}class n{constructor(t){this.tribute=t,this.tribute.menuEvents=this,this.menu=this.tribute.menu}bind(t){this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce((()=>{this.tribute.hideMenu()}),10,!1),this.windowResizeEvent=this.debounce((()=>{this.tribute.hideMenu()}),10,!1),this.windowBlurEvent=()=>{this.tribute.hideMenu()},this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),window.addEventListener("blur",this.windowBlurEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}unbind(t){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}debounce(t,e,n){let i;return()=>{const o=this,r=arguments,s=n&&!i;clearTimeout(i),i=setTimeout((()=>{i=null,n||t.apply(o,r)}),e),s&&t.apply(o,r)}}}class i{constructor(t){this.tribute=t,this.tribute.range=this}getDocument(){let t;return this.tribute.current.collection&&(t=this.tribute.current.collection.iframe),t?t.contentWindow.document:document}positionMenuAtCaret(t){const e=this.tribute.current;let n;const i=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==i){if(!this.tribute.positionMenu)return void(this.tribute.menu.style.display="block");n=this.isContentEditable(e.element)?this.getContentEditableCaretPosition(i.mentionPosition+i.mentionText.length):this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,i.mentionPosition+i.mentionText.length),this.tribute.menu.style.top=`${n.top}px`,this.tribute.menu.style.left=`${n.left}px`,this.tribute.menu.style.right=`${n.right}px`,this.tribute.menu.style.bottom=`${n.bottom}px`,this.tribute.menu.style["max-heigh"]=`${n.maxHeight||500}px`,this.tribute.menu.style["max-width"]=`${n.maxWidth||300}px`,this.tribute.menu.style.position=`${n.position||"absolute"}`,this.tribute.menu.style.display="block","auto"===n.left&&(this.tribute.menu.style.left="auto"),"auto"===n.top&&(this.tribute.menu.style.top="auto"),t&&this.scrollIntoView()}else this.tribute.menu.style.display="none"}get menuContainerIsBody(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}selectElement(t,e,n){let i=t;if(e)for(let t=0;t<e.length;t++){if(i=i.childNodes[e[t]],void 0===i)return;for(;i.length<n;)n-=i.length,i=i.nextSibling;0!==i.childNodes.length||i.length||(i=i.previousSibling)}const o=this.getWindowSelection(),r=this.getDocument().createRange();r.setStart(i,n),r.setEnd(i,n),r.collapse(!0);try{o.removeAllRanges()}catch(t){console.error(t)}o.addRange(r),t.focus()}replaceTriggerText(t,e,n,i,o){const r=this.tribute.current.info;if(void 0!==r){const e=this.tribute.current,n={item:o,instance:e,context:r,event:i,text:t},s=new CustomEvent("tribute-replaced",{detail:n});if(this.isContentEditable(e.element)){const e=t!==t.trimEnd();t+="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";let n=r.mentionPosition+r.mentionText.length+e;this.tribute.autocompleteMode||(n+=r.mentionTriggerChar.length),this.tribute.useHTML?this.pasteHtml(t,r.mentionPosition,n):this.pasteText(t,r.mentionPosition,n)}else{const e=t!==t.trimEnd(),n=this.tribute.current.element,i="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";t=this.stripHtml(t),t+=i;const o=r.mentionPosition;let s=r.mentionPosition+r.mentionText.length+i.length+e;this.tribute.autocompleteMode||(s+=r.mentionTriggerChar.length-1),n.value=n.value.substring(0,o)+t+n.value.substring(s,n.value.length),n.selectionStart=o+t.length,n.selectionEnd=o+t.length}e.element.dispatchEvent(new CustomEvent("input",{bubbles:!0,detail:n})),e.element.dispatchEvent(s)}}pasteHtml(t,e,n){const i=this.getWindowSelection();let o;if(i.modify){i.collapseToEnd(),i.modify("move","forward","word");for(let t=0;t<n-e;t++)i.modify("extend","backward","character");o=i.getRangeAt(0)}else o=this.getDocument().createRange(),o.setStart(i.anchorNode,Math.min(e,i.anchorNode.length)),o.setEnd(i.anchorNode,Math.min(n,i.anchorNode.length));o.deleteContents();const r=this.getDocument().createElement("div");r.innerHTML=t;const s=this.getDocument().createDocumentFragment();let l,c;for(;l=r.firstChild;)c=s.appendChild(l);if(o.insertNode(s),c){const t=this.getDocument().createRange();t.setStart(c,c.length),t.collapse(!0),i.removeAllRanges(),i.addRange(t),i.collapseToEnd()}}stripHtml(t){const e=document.createElement("DIV");return e.innerHTML=t,e.textContent||e.innerText||""}pasteText(t,e,n){const i=this.stripHtml(t),o=this.getDocument().createRange(),r=this.getWindowSelection();r.anchorNode.nodeValue=r.anchorNode.nodeValue.substring(0,e)+i+r.anchorNode.nodeValue.substring(n,r.anchorNode.nodeValue.length),o.setStart(r.anchorNode,e+i.length),o.collapse(!0),r.removeAllRanges(),r.addRange(o),r.collapseToEnd()}getWindowSelection(){if(this.tribute.collection.iframe)return this.tribute.collection.iframe.contentWindow.getSelection();const t=this.tribute.current.element.getRootNode();return t.getSelection?t.getSelection():window.getSelection()}getNodePositionInParent(t){if(null===t.parentNode)return 0;for(let e=0;e<t.parentNode.childNodes.length;e++){if(t.parentNode.childNodes[e]===t)return e}}getContentEditableSelectedPath(t){const e=this.getWindowSelection();let n=e.anchorNode;const i=[];let o;if(null!==n){let t,r=n.contentEditable;for(;null!==n&&"true"!==r;)t=this.getNodePositionInParent(n),i.push(t),n=n.parentNode,null!==n&&(r=n.contentEditable);return i.reverse(),o=e.getRangeAt(0).startOffset,{selected:n,path:i,offset:o}}}getWholeWordsUpToCharIndex(t,e){let n=0;const i=t.split(this.tribute.autocompleteSeparator).filter((function(t){return t.trim()})),o=t;for(let o=0,r=i.length;o<r;o++){const r=t.indexOf(i[o]);if(n+=r,t=t.slice(r),e>=n&&e<=n+i[o].length){e=n+i[o].length;break}}return o.substring(0,e)}getTextPrecedingCurrentSelection(){const t=this.tribute.current;let e="";if(this.isContentEditable(t.element)){const t=this.getWindowSelection(),n=t.anchorNode.textContent,i=this.getWindowSelection().getRangeAt(0).startOffset;if(t.modify){const o=n.substring(i-1,i),r=o!==o.trim(),s=t.getRangeAt(0);t.collapseToStart(),t.modify("move","forward","word");for(let e=0;e<this.tribute.numberOfWordsInContextText;e++)t.modify("extend","backward","word");e=t.toString().trim()+(r?" ":""),t.removeAllRanges(),t.addRange(s)}else n&&i>=0&&(e=n.substring(0),e=this.getWholeWordsUpToCharIndex(e,i))}else{const t=this.tribute.current.element;if(t){const n=t.selectionStart;t.value&&n>=0&&(e=t.value.substring(0),e=this.getWholeWordsUpToCharIndex(e,n))}}return e}getLastWordInText(t){const e=this.tribute.autocompleteSeparator?this.tribute.autocompleteSeparator:/\s+/,n=t.split(e);return n.length?n[n.length-1]:" "}getTriggerInfo(t,e,n,i,o){const r=this.tribute.current;let s,l,c;if(this.isContentEditable(r.element)){const t=this.getContentEditableSelectedPath(r);t&&(s=t.selected,l=t.path,c=t.offset)}else s=this.tribute.current.element;const u=this.getTextPrecedingCurrentSelection(),a=this.getLastWordInText(u);if(o)return{mentionPosition:u.length-a.length,mentionText:a,fullText:u,mentionSelectedElement:s,mentionSelectedPath:l,mentionSelectedOffset:c};if(null!=u){let o,r=-1;if(this.tribute.collection.forEach((t=>{const e=t.trigger,i=t.requireLeadingSpace?this.lastIndexWithLeadingSpace(u,e):u.lastIndexOf(e);i>r&&(r=i,o=e,n=t.requireLeadingSpace)})),r>=0&&(0===r||!n||/\s/.test(u.substring(r-1,r)))){let n=u.substring(r+o.length,u.length);o=u.substring(r,r+o.length);const a=n.substring(0,1),h=n.length>0&&(" "===a||" "===a);e&&(n=n.trim());const d=i?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=d.test(n),!h&&(t||!d.test(n)))return{mentionPosition:r,mentionText:n,mentionSelectedElement:s,mentionSelectedPath:l,mentionSelectedOffset:c,mentionTriggerChar:o}}}}lastIndexWithLeadingSpace(t,e){const n=t.split("").reverse().join("");let i=-1;for(let o=0,r=t.length;o<r;o++){const r=o===t.length-1,s=/\s/.test(n[o+1]);let l=!0;for(let t=e.length-1;t>=0;t--)if(e[t]!==n[o-t]){l=!1;break}if(l&&(r||s)){i=t.length-1-o;break}}return i}isContentEditable(t){return"INPUT"!==t.nodeName&&"TEXTAREA"!==t.nodeName}isMenuOffScreen(t,e){const n=window.innerWidth,i=window.innerHeight,o=document.documentElement,r=(window.pageXOffset||o.scrollLeft)-(o.clientLeft||0),s=(window.pageYOffset||o.scrollTop)-(o.clientTop||0),l="number"==typeof t.top?t.top:t.bottom-e.height,c="number"==typeof t.right?t.right:t.left+e.width,u="number"==typeof t.bottom?t.bottom:t.top+e.height,a="number"==typeof t.left?t.left:t.right-e.width;return{top:l<Math.floor(s),right:c>Math.ceil(r+n),bottom:u>Math.ceil(s+i),left:a<Math.floor(r)}}getMenuDimensions(){const t={width:null,height:null};return this.tribute.menu.style.top="0px",this.tribute.menu.style.left="0px",this.tribute.menu.style.right=null,this.tribute.menu.style.bottom=null,this.tribute.menu.style.position="fixed",this.tribute.menu.style.visibility="hidden",this.tribute.menu.style.display="block",t.width=this.tribute.menu.offsetWidth,t.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.display="none",this.tribute.menu.style.visibility="visible",t}getTextAreaOrInputUnderlinePosition(t,e,n){const i=this.getDocument().createElement("div");i.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(i);const o=i.style,r=window.getComputedStyle?getComputedStyle(t):t.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach((t=>{o[t]=r[t]}));const s=document.createElement("span");s.textContent=t.value.substring(0,e),i.appendChild(s),"INPUT"===t.nodeName&&(i.textContent=i.textContent.replace(/\s/g," "));const l=this.getDocument().createElement("span");i.appendChild(l);const c=this.getDocument().createElement("span");c.textContent=t.value.substring(e,e+1),i.appendChild(c);const u=t.getBoundingClientRect();i.style.position="fixed",i.style.left=u.left+"px",i.style.top=u.top+"px",i.style.width=u.width+"px",i.style.height=u.height+"px",i.scrollTop=t.scrollTop;const a=l.getBoundingClientRect(),h=i.getBoundingClientRect();this.getDocument().body.removeChild(i);const d=function(t,e,n){return Math.max(e,Math.min(t,n))},m={height:Math.min(h.height,a.height),left:d(a.left,h.left,h.left+h.width),top:d(a.top,h.top,h.top+h.height)};return this.getFixedCoordinatesRelativeToRect(m)}getContentEditableCaretPosition(t){const e=this.getWindowSelection();let n=null;if(e.modify){const t=e.getRangeAt(0);e.collapseToEnd(),n=e.getRangeAt(0),e.removeAllRanges(),e.addRange(t)}else{n=this.getDocument().createRange();const i=e.anchorNode.nodeType===Node.TEXT_NODE?e.anchorNode:e.anchorNode.childNodes[0];n.setStart(i,t),n.setEnd(i,t),n.collapse(!1)}const i=n.getBoundingClientRect();return this.getFixedCoordinatesRelativeToRect(i)}getFixedCoordinatesRelativeToRect(t){const e={position:"fixed",left:t.left,top:t.top+t.height},n=this.getMenuDimensions(),i=t.top,o=window.innerHeight-(t.top+t.height);o<n.height&&(i>=n.height||i>o?(e.top="auto",e.bottom=window.innerHeight-t.top,o<n.height&&(e.maxHeight=i)):i<n.height&&(e.maxHeight=o));const r=t.left,s=window.innerWidth-t.left;return s<n.width&&(r>=n.width||r>s?(e.left="auto",e.right=window.innerWidth-t.left,s<n.width&&(e.maxWidth=r)):r<n.width&&(e.maxWidth=s)),e}scrollIntoView(t){let e,n=this.menu;if(void 0===n)return;for(;void 0===e||0===e.height;)if(e=n.getBoundingClientRect(),0===e.height&&(n=n.childNodes[0],void 0===n||!n.getBoundingClientRect))return;const i=e.top,o=i+e.height;if(i<0)window.scrollTo(0,window.pageYOffset+e.top-20);else if(o>window.innerHeight){let t=window.pageYOffset+e.top-20;t-window.pageYOffset>100&&(t=window.pageYOffset+100);let n=window.pageYOffset-(window.innerHeight-o);n>t&&(n=t),window.scrollTo(0,n)}}}class o{constructor(t){this.tribute=t,this.tribute.search=this}simpleFilter(t,e){return e.filter((e=>this.test(t,e)))}test(t,e){return null!==this.match(t,e)}match(t,e,n){const i=(n=n||{}).pre||"",o=n.post||"",r=n.caseSensitive&&e||e.toLowerCase();if(n.skip)return{rendered:e,score:0};t=n.caseSensitive&&t||t.toLowerCase();const s=this.traverse(r,t,0,0,[]);return s?{rendered:this.render(e,s.cache,i,o),score:s.score}:null}traverse(t,e,n,i,o){if(this.tribute.autocompleteSeparator&&(e=e.split(this.tribute.autocompleteSeparator).splice(-1)[0]),e.length===i)return{score:this.calculateScore(o),cache:o.slice()};if(t.length===n||e.length-i>t.length-n)return;const r=e[i];let s,l,c=t.indexOf(r,n);for(;c>-1;){if(o.push(c),l=this.traverse(t,e,c+1,i+1,o),o.pop(),!l)return s;(!s||s.score<l.score)&&(s=l),c=t.indexOf(r,c+1)}return s}calculateScore(t){let e=0,n=1;return t.forEach(((i,o)=>{o>0&&(t[o-1]+1===i?n+=n+1:n=1),e+=n})),e}render(t,e,n,i){let o=t.substring(0,e[0]);return e.forEach(((r,s)=>{o+=n+t[r]+i+t.substring(r+1,e[s+1]?e[s+1]:t.length)})),o}filter(t,e,n){return n=n||{},e.reduce(((e,i,o,r)=>{let s=i;n.extract&&(s=n.extract(i),s||(s=""));const l=this.match(t,s,n);return null!==l&&(e[e.length]={string:l.rendered,score:l.score,index:o,original:i}),e}),[]).sort(((t,e)=>{const n=e.score-t.score;return n||t.index-e.index}))}}class r{constructor({values:t=null,loadingItemTemplate:s=null,iframe:l=null,selectClass:c="highlight",containerClass:u="tribute-container",itemClass:a="",trigger:h="@",autocompleteMode:d=!1,autocompleteSeparator:m=null,selectTemplate:p=null,menuItemTemplate:g=null,lookup:f="key",fillAttr:b="value",collection:v=null,menuContainer:w=null,noMatchTemplate:T=null,requireLeadingSpace:y=!0,allowSpaces:S=!1,replaceTextSuffix:x=null,positionMenu:C=!0,spaceSelectsMatch:E=!1,searchOpts:M={},menuItemLimit:A=null,menuShowMinLength:L=0,keys:I=null,useHTML:N=!0,numberOfWordsInContextText:k=5}){if(this.autocompleteMode=d,this.autocompleteSeparator=m,this.menuSelected=0,this.current={},this.isActive=!1,this.activationPending=!1,this.menuContainer=w,this.allowSpaces=S,this.replaceTextSuffix=x,this.positionMenu=C,this.hasTrailingSpace=!1,this.spaceSelectsMatch=E,this.useHTML=N,this.numberOfWordsInContextText=k,I&&(e.keys=I),this.autocompleteMode&&(h="",S=!1),t)this.collection=[{trigger:h,iframe:l,selectClass:c,containerClass:u,itemClass:a,selectTemplate:(p||r.defaultSelectTemplate).bind(this),menuItemTemplate:(g||r.defaultMenuItemTemplate).bind(this),noMatchTemplate:(t=>"string"==typeof t?""===t.trim()?null:t:"function"==typeof t?t.bind(this):T||function(){return"<li>No Match Found!</li>"})(T),lookup:f,fillAttr:b,values:t,loadingItemTemplate:s,requireLeadingSpace:y,searchOpts:M,menuItemLimit:A,menuShowMinLength:L}];else{if(!v)throw new Error("[Tribute] No collection specified.");this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=v.map((t=>({trigger:t.trigger||h,iframe:t.iframe||l,selectClass:t.selectClass||c,containerClass:t.containerClass||u,itemClass:t.itemClass||a,selectTemplate:(t.selectTemplate||r.defaultSelectTemplate).bind(this),menuItemTemplate:(t.menuItemTemplate||r.defaultMenuItemTemplate).bind(this),noMatchTemplate:(t=>"string"==typeof t?""===t.trim()?null:t:"function"==typeof t?t.bind(this):T||function(){return"<li>No Match Found!</li>"})(T),lookup:t.lookup||f,fillAttr:t.fillAttr||b,values:t.values,loadingItemTemplate:t.loadingItemTemplate,requireLeadingSpace:t.requireLeadingSpace,searchOpts:t.searchOpts||M,menuItemLimit:t.menuItemLimit||A,menuShowMinLength:t.menuShowMinLength||L})))}new i(this),new e(this),new n(this),new o(this)}get isActive(){return this._isActive}set isActive(t){if(this._isActive!==t&&(this._isActive=t,this.current.element)){const e=new CustomEvent(`tribute-active-${t}`);this.current.element.dispatchEvent(e)}}static defaultSelectTemplate(t){return void 0===t?`${this.current.collection.trigger}${this.current.mentionText}`:this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+t.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+t.original[this.current.collection.fillAttr]}static defaultMenuItemTemplate(t){return t.string}static inputTypes(){return["TEXTAREA","INPUT"]}triggers(){return this.collection.map((t=>t.trigger))}attach(t){if(!t)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&t instanceof jQuery&&(t=t.get()),t.constructor===NodeList||t.constructor===HTMLCollection||t.constructor===Array){const e=t.length;for(let n=0;n<e;++n)this._attach(t[n])}else this._attach(t)}_attach(t){t.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+t.nodeName),this.ensureEditable(t),this.events.bind(t),t.setAttribute("data-tribute",!0)}ensureEditable(t){if(-1===r.inputTypes().indexOf(t.nodeName)){if(!t.contentEditable)throw new Error("[Tribute] Cannot bind to "+t.nodeName);t.contentEditable=!0}}createMenu(t,e){const n=window.getComputedStyle?getComputedStyle(e):e.currentStyle,i=this.range.getDocument().createElement("div"),o=this.range.getDocument().createElement("ul");return i.className=t,i.setAttribute("tabindex","0"),i.appendChild(o),i.style.fontSize=Math.round(.9*parseInt(n.fontSize))+"px",i.style.display="none",["fontStyle","fontVariant","fontWeight","fontStretch","fontSizeAdjust","fontFamily"].forEach((t=>{i.style[t]=n[t]})),this.menuContainer?this.menuContainer.appendChild(i):this.range.getDocument().body.appendChild(i)}showMenuFor(t,e){if(this.isActive&&this.current.element===t&&this.current.mentionText===this.currentMentionTextSnapshot)return;this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass,t),t.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.activationPending=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText="");const n=(t,n)=>{if(!this.activationPending)return;if(this.activationPending=!1,document.activeElement!==this.current.element)return;if(n)return this.current.info.mentionPosition-=n.length,this.current.info.mentionText=" ".repeat(n.length)+this.current.info.mentionText,void this.replaceText(n.text,null,null);let i=this.search.filter(this.current.mentionText,t,{pre:this.current.collection.searchOpts.pre||"<span>",post:this.current.collection.searchOpts.post||"</span>",skip:this.current.collection.searchOpts.skip,extract:t=>{if("string"==typeof this.current.collection.lookup)return t[this.current.collection.lookup];if("function"==typeof this.current.collection.lookup)return this.current.collection.lookup(t,this.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});this.current.collection.menuItemLimit&&(i=i.slice(0,this.current.collection.menuItemLimit)),this.current.filteredItems=i;const o=this.menu.querySelector("ul");let r=!1;if(i.length){o.innerHTML="";const t=this.range.getDocument().createDocumentFragment();i.forEach(((e,n)=>{const i=this.range.getDocument().createElement("li");i.setAttribute("data-index",n),i.className=this.current.collection.itemClass,i.addEventListener("mousemove",(t=>{const[,e]=this._findLiTarget(t.target);0!==t.movementY&&this.events.setActiveLi(e)})),this.menuSelected===n&&i.classList.add(this.current.collection.selectClass),i.innerHTML=this.current.collection.menuItemTemplate(e),t.appendChild(i)})),o.appendChild(t),r=!0}else{const t=new CustomEvent("tribute-no-match",{detail:this.menu});this.current.element.dispatchEvent(t),"function"==typeof this.current.collection.noMatchTemplate&&!this.current.collection.noMatchTemplate()||!this.current.collection.noMatchTemplate?r=!1:("function"==typeof this.current.collection.noMatchTemplate?o.innerHTML=this.current.collection.noMatchTemplate():o.innerHTML=this.current.collection.noMatchTemplate,r=!0)}r&&(this.isActive=!0,this.range.positionMenuAtCaret(e))};"function"==typeof this.current.collection.values?(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(e)),this.current.collection.values(this.current.mentionText,n,this.current.fullText)):n(this.current.collection.values)}_findLiTarget(t){if(!t)return[];const e=t.getAttribute("data-index");return e?[t,e]:this._findLiTarget(t.parentNode)}showMenuForCollection(t,e){this.events.updateSelection(t)&&(t!==document.activeElement&&(this.placeCaretAtEnd(t),t.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(t,this.current.collection.trigger)),this.current.collection=this.collection[e||0],this.current.element=t,this.showMenuFor(t))}placeCaretAtEnd(t){if(t.focus(),void 0!==window.getSelection&&void 0!==document.createRange){const e=document.createRange();e.selectNodeContents(t),e.collapse(!1);const n=window.getSelection();n.removeAllRanges(),n.addRange(e)}else if(void 0!==document.body.createTextRange){const e=document.body.createTextRange();e.moveToElementText(t),e.collapse(!1),e.select()}}insertTextAtCursor(t){const e=window.getSelection(),n=e.getRangeAt(0);n.deleteContents();const i=document.createTextNode(t);n.insertNode(i),n.selectNodeContents(i),n.collapse(!1),e.removeAllRanges(),e.addRange(n)}insertAtCaret(t,e){const n=t.scrollTop;let i=t.selectionStart;const o=t.value.substring(0,i),r=t.value.substring(t.selectionEnd,t.value.length);t.value=o+e+r,i+=e.length,t.selectionStart=i,t.selectionEnd=i,t.focus(),t.scrollTop=n}hideMenu(){this.menu&&(this.menu.remove(),this.menu=null),this.isActive=!1,this.activationPending=!1}selectItemAtIndex(t,e){if(this.hideMenu(),"number"!=typeof(t=parseInt(t))||isNaN(t)||!e.target)return;const n=this.current.filteredItems[t],i=this.current.collection.selectTemplate(n);null!==i&&this.replaceText(i,e,n)}replaceText(t,e,n){this.range.replaceTriggerText(t,!0,!0,e,n)}_append(t,e,n){if("function"==typeof t.values)throw new Error("Unable to append to values, as it is a function.");t.values=n?e:t.values.concat(e)}append(t,e,n){const i=parseInt(t);if("number"!=typeof i)throw new Error("please provide an index for the collection to update.");const o=this.collection[i];this._append(o,e,n)}appendCurrent(t,e){if(!this.isActive)throw new Error("No active state. Please use append instead and pass an index.");this._append(this.current.collection,t,e)}detach(t){if(!t)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&t instanceof jQuery&&(t=t.get()),t.constructor===NodeList||t.constructor===HTMLCollection||t.constructor===Array){const e=t.length;for(let n=0;n<e;++n)this._detach(t[n])}else this._detach(t)}_detach(t){this.events.unbind(t),t.tributeMenu&&this.menuEvents.unbind(t.tributeMenu),setTimeout((()=>{t.removeAttribute("data-tribute"),this.isActive=!1,t.tributeMenu&&t.tributeMenu.remove()}))}}return r}));
//# sourceMappingURL=tribute.min.js.map
